<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 10: Object Data Modelling with Mongoose | MAD9124</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Full-stack: API Development">
    
    <link rel="preload" href="/w2024/assets/css/0.styles.20dcd3d9.css" as="style"><link rel="preload" href="/w2024/assets/js/app.5ee3ed65.js" as="script"><link rel="preload" href="/w2024/assets/js/3.761d8bc7.js" as="script"><link rel="preload" href="/w2024/assets/js/31.69913944.js" as="script"><link rel="preload" href="/w2024/assets/js/16.9d7e7ca9.js" as="script"><link rel="prefetch" href="/w2024/assets/js/10.91abb132.js"><link rel="prefetch" href="/w2024/assets/js/11.23436bee.js"><link rel="prefetch" href="/w2024/assets/js/12.cdb0aa93.js"><link rel="prefetch" href="/w2024/assets/js/13.db6a866c.js"><link rel="prefetch" href="/w2024/assets/js/14.af9a21bb.js"><link rel="prefetch" href="/w2024/assets/js/15.a3775641.js"><link rel="prefetch" href="/w2024/assets/js/17.91f5106a.js"><link rel="prefetch" href="/w2024/assets/js/18.35f59eae.js"><link rel="prefetch" href="/w2024/assets/js/19.cc1df2bb.js"><link rel="prefetch" href="/w2024/assets/js/2.a4c470a3.js"><link rel="prefetch" href="/w2024/assets/js/20.ba5a082d.js"><link rel="prefetch" href="/w2024/assets/js/21.b86c7a27.js"><link rel="prefetch" href="/w2024/assets/js/22.75d42f17.js"><link rel="prefetch" href="/w2024/assets/js/23.04aeda2e.js"><link rel="prefetch" href="/w2024/assets/js/24.335cc94a.js"><link rel="prefetch" href="/w2024/assets/js/25.c474d0c4.js"><link rel="prefetch" href="/w2024/assets/js/26.2fc871eb.js"><link rel="prefetch" href="/w2024/assets/js/27.1a2b145e.js"><link rel="prefetch" href="/w2024/assets/js/28.da37c563.js"><link rel="prefetch" href="/w2024/assets/js/29.1c89b303.js"><link rel="prefetch" href="/w2024/assets/js/30.44e5d812.js"><link rel="prefetch" href="/w2024/assets/js/32.1ccb7167.js"><link rel="prefetch" href="/w2024/assets/js/33.07320599.js"><link rel="prefetch" href="/w2024/assets/js/34.0b22a8d5.js"><link rel="prefetch" href="/w2024/assets/js/35.eb14ba24.js"><link rel="prefetch" href="/w2024/assets/js/36.a79b7478.js"><link rel="prefetch" href="/w2024/assets/js/37.4c12ca4b.js"><link rel="prefetch" href="/w2024/assets/js/38.28dfe7e1.js"><link rel="prefetch" href="/w2024/assets/js/39.192b839e.js"><link rel="prefetch" href="/w2024/assets/js/4.4953fdcc.js"><link rel="prefetch" href="/w2024/assets/js/40.decb6661.js"><link rel="prefetch" href="/w2024/assets/js/41.dad64be3.js"><link rel="prefetch" href="/w2024/assets/js/42.b619627d.js"><link rel="prefetch" href="/w2024/assets/js/5.5b3c9a3d.js"><link rel="prefetch" href="/w2024/assets/js/6.bd8136df.js"><link rel="prefetch" href="/w2024/assets/js/7.7b3b7681.js"><link rel="prefetch" href="/w2024/assets/js/8.a4069f12.js"><link rel="prefetch" href="/w2024/assets/js/9.b863f436.js">
    <link rel="stylesheet" href="/w2024/assets/css/0.styles.20dcd3d9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/w2024/" class="home-link router-link-active"><!----> <span class="site-name">MAD9124</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/w2024/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2024/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/w2024/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2024/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/w2024/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2024/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/w2024/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2024/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Content Modules</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/w2024/modules/" aria-current="page" class="sidebar-link">Table of contents</a></li><li><a href="/w2024/modules/week1/" class="sidebar-link">Week 1: Introduction &amp; Review</a></li><li><a href="/w2024/modules/week2/" class="sidebar-link">Week 2: Node Modules &amp; Express</a></li><li><a href="/w2024/modules/week3/" class="sidebar-link">Week 3: APIs</a></li><li><a href="/w2024/modules/week4/" class="sidebar-link">Week 4: Project Structure, RESTful alternatives, and Postman</a></li><li><a href="/w2024/modules/week5/" class="sidebar-link">Week 5: API Integration &amp; Caching</a></li><li><a href="/w2024/modules/week6/" class="sidebar-link">Week 6: Midterm Project</a></li><li><a href="/w2024/modules/week7/" class="sidebar-link">Week 7: Middleware</a></li><li><a href="/w2024/modules/break-week/" class="sidebar-link">Break Week</a></li><li><a href="/w2024/modules/week9/" class="sidebar-link">Week 9: Data Persitance and MongoDB</a></li><li><a href="/w2024/modules/week10/" aria-current="page" class="active sidebar-link">Week 10: Object Data Modelling with Mongoose</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2024/modules/week10/#agenda" class="sidebar-link">Agenda</a></li><li class="sidebar-sub-header"><a href="/w2024/modules/week10/#object-data-modelling-with-mongoose" class="sidebar-link">Object Data Modelling with Mongoose</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2024/modules/week10/#schema" class="sidebar-link">Schema</a></li><li class="sidebar-sub-header"><a href="/w2024/modules/week10/#schema-types" class="sidebar-link">Schema Types</a></li><li class="sidebar-sub-header"><a href="/w2024/modules/week10/#making-models" class="sidebar-link">Making Models</a></li><li class="sidebar-sub-header"><a href="/w2024/modules/week10/#relationships" class="sidebar-link">Relationships</a></li><li class="sidebar-sub-header"><a href="/w2024/modules/week10/#mongo-query-operators" class="sidebar-link">Mongo Query Operators</a></li><li class="sidebar-sub-header"><a href="/w2024/modules/week10/#mongoose-query-helpers" class="sidebar-link">Mongoose Query Helpers</a></li></ul></li><li class="sidebar-sub-header"><a href="/w2024/modules/week10/#assignment-mongodb-crud-on-the-cloud-using-pet-data" class="sidebar-link">Assignment - MongoDB CRUD on the cloud using Pet data</a></li></ul></li><li><a href="/w2024/modules/week11/" class="sidebar-link">Week 11: Data Santization, XSS and LoggingS</a></li><li><a href="/w2024/modules/week12/" class="sidebar-link">Week 12: Authentication With Passport</a></li><li><a href="/w2024/modules/week13/" class="sidebar-link">Week 13: Testing with Jest</a></li><li><a href="/w2024/modules/week14/" class="sidebar-link">Week 14: Preparing for Production</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1><span class="week">Week 10</span><br> <span class="title">Object Data Modelling with Mongoose</span></h1> <h2 id="agenda"><a href="#agenda" class="header-anchor">#</a> Agenda</h2> <ul><li>AMA (15 min)</li> <li>Mongoose Models (20 mins)</li> <li>Mongoose Query Methods (10 mins)</li> <li>MongoDB on Atlas</li> <li>Assignment MongoDB CRUN on Cloud</li></ul> <h2 id="object-data-modelling-with-mongoose"><a href="#object-data-modelling-with-mongoose" class="header-anchor">#</a> Object Data Modelling with Mongoose</h2> <h1 id="mongoose-models"><a href="#mongoose-models" class="header-anchor">#</a> Mongoose Models</h1> <hr> <p>Mongoose is a Node.js based Object Data Modelling (ODM) library for MongoDB. It is used to abstract away the lower level MongoDB access APIs and manage the shape of application resource data structures. This is the <strong>M</strong> in the MVC software architecture pattern.</p> <p>Mongoose provides two core features to simplify the implementation of a MongoDB backed application.</p> <ol><li>The <code>mongoose.model()</code> method is a class factory -- meaning it is a function that returns a new class object which we can then use to instantiate individual document objects. This factory function takes two arguments: the name of the resource that this model represents, and a schema object describing the properties of that resource.</li> <li>The <code>mongoose.Schema</code> class is used to define the expected shape of resource properties -- their names, types, and validation limits.</li></ol> <h3 id="schema"><a href="#schema" class="header-anchor">#</a> Schema</h3> <p>A model schema could be a simple object specifying the property names and types.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> catSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Or it can be expressed with more detailed options.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> catSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token literal-property property">minlength</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token literal-property property">maxlength</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> Number<span class="token punctuation">,</span> <span class="token literal-property property">min</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token number">25</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="schema-types"><a href="#schema-types" class="header-anchor">#</a> Schema Types</h3> <p>The following <a href="https://mongoosejs.com/docs/schematypes.html" target="_blank" rel="noopener noreferrer">Mongoose Schema Types (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> are permitted:</p> <ul><li>Array</li> <li>Boolean</li> <li>Buffer</li> <li>Date</li> <li>Mixed (A generic / flexible data type)</li> <li>Number</li> <li>ObjectId</li> <li>String</li></ul> <p><strong>Mixed</strong> and <strong>ObjectId</strong> are defined under <code>mongoose.Schema.Types</code>. We will look at this a little later when we create an owner relationship for the cars API.</p> <h3 id="making-models"><a href="#making-models" class="header-anchor">#</a> Making Models</h3> <p>Start by using the schema object with the <code>model()</code> factory method to generate a new class.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Cat <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;Cat&quot;</span><span class="token punctuation">,</span> catSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>... and then we can use that Cat model to instantiate a new Mongoose document instance.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> kitty <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Spot&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The <code>mongoose.model</code> factory function generates new class objects, customized with the given schema, that inherit all of the methods required to interact with the MongoDB service. This includes a list of <a href="https://mongoosejs.com/docs/queries.html" target="_blank" rel="noopener noreferrer">static class methods (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> as well as <a href="https://mongoosejs.com/docs/guide.html#methods" target="_blank" rel="noopener noreferrer">instance methods (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. e.g.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// example class method</span>
Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// example instance method</span>
kitty<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="relationships"><a href="#relationships" class="header-anchor">#</a> Relationships</h3> <p>Most applications have more complex data structures than our simple Cat model. Often this involves a relationship to another model. For example we might want to extend the Cat model to include an owner. In traditional SQL database systems, this means creating a new table to store the details about the Person that is the owner of the Cat, and then adding a new property like <code>owner_id</code> to the Cat schema to store the foreign key pointer to <code>people.id</code>.</p> <p>Document databases like <a href="https://docs.mongodb.com/manual/applications/data-models-relationships/" target="_blank" rel="noopener noreferrer">MongoDB give us two options (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: embedded documents, and document references.</p> <h4 id="document-references"><a href="#document-references" class="header-anchor">#</a> Document References</h4> <p>Document references are similar to an SQL foreign key. It stores the <code>_id</code> value of a document in another collection. Unlike SQL databases this relationship is not enforced at the database level -- there is no validation that the reference id exists. We would add it to the schema like this, where the <code>ref</code> option is the name of another model class in our application.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> catSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token literal-property property">minlength</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token literal-property property">maxlength</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> Number<span class="token punctuation">,</span> <span class="token literal-property property">min</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token number">25</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">owner</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span> <span class="token literal-property property">ref</span><span class="token operator">:</span> <span class="token string">&quot;Person&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Another difference from SQL is that the reference property could be an array.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> catSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token literal-property property">minlength</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token literal-property property">maxlength</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> Number<span class="token punctuation">,</span> <span class="token literal-property property">min</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token number">25</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">owners</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span> <span class="token literal-property property">ref</span><span class="token operator">:</span> <span class="token string">&quot;Person&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="example-usage"><a href="#example-usage" class="header-anchor">#</a> Example usage</h5> <p>The <code>owners</code> property stores an array of one or more <a href="https://mongoosejs.com/docs/schematypes.html#objectids" target="_blank" rel="noopener noreferrer">ObjectId (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> references to the unique <code>_id</code> of a document in the <code>Person</code> collection.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Cat <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;Cat&quot;</span><span class="token punctuation">,</span> catSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> kitty <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Fluffy&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token literal-property property">owners</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;6021b7be9d383359e30a1327&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;6021b94e6a3a0b5a03fcd7ba&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="embedded-documents"><a href="#embedded-documents" class="header-anchor">#</a> Embedded Documents</h4> <p>The other option is to embed the related documents as properties of the main document.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> personSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">firstName</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
  <span class="token literal-property property">lastName</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
  <span class="token literal-property property">phoneNumber</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> catSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token literal-property property">minlength</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token literal-property property">maxlength</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> Number<span class="token punctuation">,</span> <span class="token literal-property property">min</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token number">25</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">owners</span><span class="token operator">:</span> <span class="token punctuation">[</span>personSchema<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Cat <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;Cat&quot;</span><span class="token punctuation">,</span> catSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> kitty <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Fluffy&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token literal-property property">owners</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">&quot;Mickey&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">&quot;Mouse&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">phoneNumber</span><span class="token operator">:</span> <span class="token number">14155551212</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">&quot;Minnie&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">&quot;Mouse&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">phoneNumber</span><span class="token operator">:</span> <span class="token number">14155551212</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Trade-offs</p> <p>The relationship modelling method you choose is ultimately a trade-off between read query speed and data consistency.</p> <p>The referenced document method ensures that data remains consistent because it is stored in only one place for each schema model, but it requires an additional database query for each related document when retrieving the primary document. For queries returning a single document (most CRUD operations) this may be fine. However for complex search queries returning thousands of results, there could be a significant performance hit.</p> <p>The embedded document method avoids these additional database queries when retrieving data, but exponentially increases the complexity of maintaining data consistency because you are potentially storing the same data in many places and need to update them all manually.</p> <p>If we look at the Cat example above, and consider what happens when we want to change Mickey Mouse's phone number. In the reference method, we simply find the Person document for Mickey Mouse and update the phoneNumber property. Then whenever we need to contact Fluffy's owner, the data will be correct.</p> <p>However if we use the embedded method, we have to lookup all of the Cats that have an owner with the name Mickey Mouse and then update the embedded phone number. But what if there is more than one Person named Mickey Mouse? How do we know if we are updating the correct information? It can get messy if you don't plan it out well.</p> <h1 id="mongoose-query-methods"><a href="#mongoose-query-methods" class="header-anchor">#</a> Mongoose Query Methods</h1> <hr> <blockquote><p>Mongoose models provide several static helper functions for <strong>CRUD operations</strong>. Each of these functions returns a <a href="http://mongoosejs.com/docs/api.html#Query" target="_blank" rel="noopener noreferrer">mongoose Query object (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ... A query also has a <code>.then()</code> function, and thus can be used as a promise.</p></blockquote> <p>Review the <a href="https://mongoosejs.com/docs/queries.html" target="_blank" rel="noopener noreferrer">mongoose documentation (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for the full list, but these are the most common ones that we will be using.</p> <p><a href="https://mongoosejs.com/docs/api.html#model_Model.find" target="_blank" rel="noopener noreferrer">Model.find() (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is used to get an array of documents matching the given filter criteria.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> catsNamedSpot <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Spot&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>These methods act on a single document matching the given id parameter.</p> <ul><li>Model.findById()</li> <li>Model.findByIdAndRemove()</li> <li>Model.findByIdAndUpdate()</li></ul> <p>These methods act on the first document found matching the given filter criteria.</p> <ul><li>Model.findOne()</li> <li>Model.findOneAndRemove()</li> <li>Model.findOneAndUpdate()</li></ul> <h3 id="mongo-query-operators"><a href="#mongo-query-operators" class="header-anchor">#</a> Mongo Query Operators</h3> <p>In the filter criteria objects we can use any of the standard <a href="https://docs.mongodb.com/manual/reference/operator/query/" target="_blank" rel="noopener noreferrer">MongoDB query operators (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. The syntax is to provide an object as the filter condition value for the given property. That object will have one of the Mongo query operators as it's key and the corresponding relative value. Let's look at some examples.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> catsAgedFourOrMore <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">$gte</span><span class="token operator">:</span> <span class="token number">4</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> catsAgedLessThanFour <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">$lt</span><span class="token operator">:</span> <span class="token number">4</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> catsAgedTwoFourOrSix <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token punctuation">{</span> $<span class="token keyword">in</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> catsNotAgedTwoFourOrSix <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">$nin</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="mongoose-query-helpers"><a href="#mongoose-query-helpers" class="header-anchor">#</a> Mongoose Query Helpers</h3> <p>Mongoose provides some <a href="https://mongoosejs.com/docs/api.html#Query" target="_blank" rel="noopener noreferrer">helper functions (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to make writing your queries more fluent. The syntax is sometimes more readable, but the end result is exactly the same. So, use whichever method is easier for you.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> catsAgedFourOrMore <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> catsAgedLessThanFour <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> catsAgedTwoFourOrSix <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> catsNotAgedTwoFourOrSix <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nin</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="assignment-mongodb-crud-on-the-cloud-using-pet-data"><a href="#assignment-mongodb-crud-on-the-cloud-using-pet-data" class="header-anchor">#</a> Assignment - MongoDB CRUD on the cloud using Pet data</h2> <p>Instructions can be found <a href="/w2024/deliverables/assignment2.html">here</a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/10/2024, 5:20:11 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/w2024/modules/week9/" class="prev">
        Week 9: Data Persitance and MongoDB
      </a></span> <span class="next"><a href="/w2024/modules/week11/">
        Week 11: Data Santization, XSS and LoggingS
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/w2024/assets/js/app.5ee3ed65.js" defer></script><script src="/w2024/assets/js/3.761d8bc7.js" defer></script><script src="/w2024/assets/js/31.69913944.js" defer></script><script src="/w2024/assets/js/16.9d7e7ca9.js" defer></script>
  </body>
</html>
